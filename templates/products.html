{% extends "base.html" %}

{% block title %}Products - Product Importer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="bi bi-list-ul"></i> Products</h2>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle"></i> Create Product
                </button>
                <button class="btn btn-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash"></i> Delete All
                </button>
            </div>
        </div>
    </div>
</div>

<div class="filter-section">
    <div class="row g-3">
        <div class="col-md-3">
            <input type="text" class="form-control" id="filterSku" placeholder="Filter by SKU" onkeyup="filterProducts()">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="filterName" placeholder="Filter by Name" onkeyup="filterProducts()">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterActive" onchange="filterProducts()">
                <option value="">All Status</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>
        <div class="col-md-2">
            <input type="text" class="form-control" id="filterDescription" placeholder="Filter by Description" onkeyup="filterProducts()">
        </div>
        <div class="col-md-1">
            <button class="btn btn-outline-secondary w-100" onclick="clearFilters()" title="Clear all filters">
                <i class="bi bi-x-circle"></i> Clear
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>SKU</th>
                        <th>Description</th>
                        <th>Active</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <tr>
                        <td colspan="7" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- Description View Modal -->
<div class="modal fade" id="descriptionModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Product Description</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="fullDescription" style="white-space: pre-wrap;"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Create Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label for="productName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productSku" class="form-label">SKU *</label>
                        <input type="text" class="form-control" id="productSku" required>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="productActive" checked>
                            <label class="form-check-label" for="productActive">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_BASE = '/api/products';
let currentPage = 1;
let filters = {};

function filterProducts() {
    filters = {
        sku: document.getElementById('filterSku').value,
        name: document.getElementById('filterName').value,
        active: document.getElementById('filterActive').value,
        description: document.getElementById('filterDescription').value
    };
    currentPage = 1;
    loadProducts();
}

function clearFilters() {
    document.getElementById('filterSku').value = '';
    document.getElementById('filterName').value = '';
    document.getElementById('filterActive').value = '';
    document.getElementById('filterDescription').value = '';
    filters = {};
    currentPage = 1;
    loadProducts();
}

function loadProducts() {
    const tbody = document.getElementById('productsTable');
    // Show loading state
    tbody.innerHTML = '<tr><td colspan="7" class="text-center"><span class="spinner-border spinner-border-sm me-2"></span>Loading products...</td></tr>';
    
    const params = new URLSearchParams({ page: currentPage });
    Object.keys(filters).forEach(key => {
        if (filters[key]) params.append(key, filters[key]);
    });
    
    fetch(`${API_BASE}/?${params}`)
        .then(res => {
            if (!res.ok) {
                throw new Error(`HTTP error! status: ${res.status}`);
            }
            return res.json();
        })
        .then(data => {
            renderProducts(data.results || []);
            renderPagination(data);
        })
        .catch(err => {
            console.error('Error loading products:', err);
            document.getElementById('productsTable').innerHTML = 
                '<tr><td colspan="7" class="text-center text-danger">Error loading products</td></tr>';
            showToast('Error', 'Failed to load products. Please try again.', 'error');
        });
}

function renderProducts(products) {
    const tbody = document.getElementById('productsTable');
    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="text-center">No products found</td></tr>';
        return;
    }
    
    tbody.innerHTML = products.map(p => {
        const desc = p.description || '';
        const truncatedDesc = desc.length > 80 ? desc.substring(0, 80) + '...' : desc;
        const hasLongDesc = desc.length > 80;
        // Escape description for JavaScript (handle quotes and newlines)
        const escapedDesc = desc.replace(/\\/g, '\\\\').replace(/'/g, "\\'").replace(/\n/g, '\\n').replace(/\r/g, '\\r');
        
        return `
        <tr>
            <td>${p.id}</td>
            <td>${escapeHtml(p.name)}</td>
            <td><code>${escapeHtml(p.sku)}</code></td>
            <td>
                <span class="text-muted">${truncatedDesc ? escapeHtml(truncatedDesc) : '<em>No description</em>'}</span>
                ${hasLongDesc ? `<button class="btn btn-sm btn-link p-0 ms-1" onclick="viewDescription(${p.id}, '${escapedDesc}')" title="View full description">
                    <i class="bi bi-eye text-primary"></i>
                </button>` : ''}
            </td>
            <td>${p.active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
            <td>${new Date(p.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editProduct(${p.id})" title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `;
    }).join('');
}

function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    if (!data.next && !data.previous) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    if (data.previous) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
    }
    html += `<li class="page-item active"><span class="page-link">Page ${currentPage}</span></li>`;
    if (data.next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
    }
    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadProducts();
}

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Create Product';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productActive').checked = true;
}

function editProduct(id) {
    const editBtn = event.target.closest('button');
    const originalBtnText = editBtn.innerHTML;
    editBtn.disabled = true;
    editBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch(`${API_BASE}/${id}/`)
        .then(res => {
            if (!res.ok) {
                throw new Error('Failed to load product');
            }
            return res.json();
        })
        .then(product => {
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productSku').value = product.sku;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productActive').checked = product.active;
            new bootstrap.Modal(document.getElementById('productModal')).show();
        })
        .catch(err => {
            showToast('Error', err.message || 'Failed to load product', 'error');
        })
        .finally(() => {
            editBtn.disabled = false;
            editBtn.innerHTML = originalBtnText;
        });
}

function showToast(title, message, type = 'success') {
    const toastEl = document.getElementById('toast');
    const toastTitle = document.getElementById('toastTitle');
    const toastMessage = document.getElementById('toastMessage');
    const toastIcon = document.getElementById('toastIcon');
    
    // Set icon based on type
    toastIcon.className = type === 'success' 
        ? 'bi bi-check-circle-fill text-success me-2'
        : 'bi bi-exclamation-circle-fill text-danger me-2';
    
    toastTitle.textContent = title;
    toastMessage.textContent = message;
    
    const toast = new bootstrap.Toast(toastEl, { autohide: true, delay: 3000 });
    toast.show();
}

function saveProduct() {
    const id = document.getElementById('productId').value;
    const isEdit = !!id;
    const saveBtn = document.querySelector('#productModal .btn-primary');
    const originalBtnText = saveBtn.innerHTML;
    
    // Show loading state
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Saving...';
    
    const data = {
        name: document.getElementById('productName').value,
        sku: document.getElementById('productSku').value,
        description: document.getElementById('productDescription').value,
        active: document.getElementById('productActive').checked
    };
    
    const url = id ? `${API_BASE}/${id}/` : `${API_BASE}/`;
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => {
        if (!res.ok) {
            return res.json().then(err => {
                throw new Error(err.detail || err.non_field_errors || 'Failed to save product');
            });
        }
        return res.json();
    })
    .then(() => {
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        currentPage = 1; // Go to first page to see newly created product
        loadProducts();
        showToast(
            'Success',
            isEdit ? 'Product updated successfully!' : 'Product created successfully!',
            'success'
        );
    })
    .catch(err => {
        showToast('Error', err.message || 'Failed to save product', 'error');
    })
    .finally(() => {
        saveBtn.disabled = false;
        saveBtn.innerHTML = originalBtnText;
    });
}

function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    // Show loading state on the delete button
    const deleteBtn = event.target.closest('button');
    const originalBtnText = deleteBtn.innerHTML;
    deleteBtn.disabled = true;
    deleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm"></span>';
    
    fetch(`${API_BASE}/${id}/`, { method: 'DELETE' })
        .then(res => {
            if (!res.ok) {
                throw new Error('Failed to delete product');
            }
            // Handle 204 No Content (no body) or 200 OK with JSON
            if (res.status === 204) {
                return null; // No content to parse
            }
            return res.json();
        })
        .then(() => {
            // Refresh the product list to show updated data
            loadProducts();
            showToast('Success', 'Product deleted successfully!', 'success');
        })
        .catch(err => {
            showToast('Error', err.message || 'Failed to delete product', 'error');
        })
        .finally(() => {
            deleteBtn.disabled = false;
            deleteBtn.innerHTML = originalBtnText;
        });
}

function bulkDelete() {
    if (!confirm('Are you sure you want to delete ALL products? This cannot be undone!')) return;
    
    const bulkDeleteBtn = event.target;
    const originalBtnText = bulkDeleteBtn.innerHTML;
    bulkDeleteBtn.disabled = true;
    bulkDeleteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Deleting...';
    
    fetch(`${API_BASE}/bulk-delete/`, { method: 'DELETE' })
        .then(res => {
            if (!res.ok) {
                throw new Error('Failed to delete products');
            }
            return res.json();
        })
        .then(data => {
            currentPage = 1;
            loadProducts();
            showToast('Success', data.message || 'All products deleted successfully!', 'success');
        })
        .catch(err => {
            showToast('Error', err.message || 'Failed to delete products', 'error');
        })
        .finally(() => {
            bulkDeleteBtn.disabled = false;
            bulkDeleteBtn.innerHTML = originalBtnText;
        });
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function viewDescription(productId, description) {
    // Unescape the description (handle escaped newlines and quotes)
    const unescapedDesc = description
        .replace(/\\n/g, '\n')
        .replace(/\\r/g, '\r')
        .replace(/\\'/g, "'")
        .replace(/\\\\/g, '\\');
    document.getElementById('fullDescription').textContent = unescapedDesc || 'No description available.';
    new bootstrap.Modal(document.getElementById('descriptionModal')).show();
}

// Load products on page load
loadProducts();
</script>
{% endblock %}

