{% extends "base.html" %}

{% block title %}Products - Product Importer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="bi bi-list-ul"></i> Products</h2>
            <div>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#productModal" onclick="openCreateModal()">
                    <i class="bi bi-plus-circle"></i> Create Product
                </button>
                <button class="btn btn-danger" onclick="bulkDelete()">
                    <i class="bi bi-trash"></i> Delete All
                </button>
            </div>
        </div>
    </div>
</div>

<div class="filter-section">
    <div class="row g-3">
        <div class="col-md-3">
            <input type="text" class="form-control" id="filterSku" placeholder="Filter by SKU" onkeyup="filterProducts()">
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="filterName" placeholder="Filter by Name" onkeyup="filterProducts()">
        </div>
        <div class="col-md-3">
            <select class="form-select" id="filterActive" onchange="filterProducts()">
                <option value="">All Status</option>
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>
        <div class="col-md-3">
            <input type="text" class="form-control" id="filterDescription" placeholder="Filter by Description" onkeyup="filterProducts()">
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>SKU</th>
                        <th>Active</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="productsTable">
                    <tr>
                        <td colspan="6" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center" id="pagination">
            </ul>
        </nav>
    </div>
</div>

<!-- Product Modal -->
<div class="modal fade" id="productModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Create Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="productForm">
                    <input type="hidden" id="productId">
                    <div class="mb-3">
                        <label for="productName" class="form-label">Name *</label>
                        <input type="text" class="form-control" id="productName" required>
                    </div>
                    <div class="mb-3">
                        <label for="productSku" class="form-label">SKU *</label>
                        <input type="text" class="form-control" id="productSku" required>
                    </div>
                    <div class="mb-3">
                        <label for="productDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="productDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="productActive" checked>
                            <label class="form-check-label" for="productActive">Active</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_BASE = '/api/products';
let currentPage = 1;
let filters = {};

function filterProducts() {
    filters = {
        sku: document.getElementById('filterSku').value,
        name: document.getElementById('filterName').value,
        active: document.getElementById('filterActive').value,
        description: document.getElementById('filterDescription').value
    };
    currentPage = 1;
    loadProducts();
}

function loadProducts() {
    const params = new URLSearchParams({ page: currentPage });
    Object.keys(filters).forEach(key => {
        if (filters[key]) params.append(key, filters[key]);
    });
    
    fetch(`${API_BASE}/?${params}`)
        .then(res => res.json())
        .then(data => {
            renderProducts(data.results || []);
            renderPagination(data);
        })
        .catch(err => {
            console.error('Error loading products:', err);
            document.getElementById('productsTable').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading products</td></tr>';
        });
}

function renderProducts(products) {
    const tbody = document.getElementById('productsTable');
    if (products.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No products found</td></tr>';
        return;
    }
    
    tbody.innerHTML = products.map(p => `
        <tr>
            <td>${p.id}</td>
            <td>${p.name}</td>
            <td><code>${p.sku}</code></td>
            <td>${p.active ? '<span class="badge bg-success">Active</span>' : '<span class="badge bg-secondary">Inactive</span>'}</td>
            <td>${new Date(p.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-primary" onclick="editProduct(${p.id})">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct(${p.id})">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function renderPagination(data) {
    const pagination = document.getElementById('pagination');
    if (!data.next && !data.previous) {
        pagination.innerHTML = '';
        return;
    }
    
    let html = '';
    if (data.previous) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage - 1})">Previous</a></li>`;
    }
    html += `<li class="page-item active"><span class="page-link">Page ${currentPage}</span></li>`;
    if (data.next) {
        html += `<li class="page-item"><a class="page-link" href="#" onclick="changePage(${currentPage + 1})">Next</a></li>`;
    }
    pagination.innerHTML = html;
}

function changePage(page) {
    currentPage = page;
    loadProducts();
}

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Create Product';
    document.getElementById('productForm').reset();
    document.getElementById('productId').value = '';
    document.getElementById('productActive').checked = true;
}

function editProduct(id) {
    fetch(`${API_BASE}/${id}/`)
        .then(res => res.json())
        .then(product => {
            document.getElementById('modalTitle').textContent = 'Edit Product';
            document.getElementById('productId').value = product.id;
            document.getElementById('productName').value = product.name;
            document.getElementById('productSku').value = product.sku;
            document.getElementById('productDescription').value = product.description || '';
            document.getElementById('productActive').checked = product.active;
            new bootstrap.Modal(document.getElementById('productModal')).show();
        });
}

function saveProduct() {
    const id = document.getElementById('productId').value;
    const data = {
        name: document.getElementById('productName').value,
        sku: document.getElementById('productSku').value,
        description: document.getElementById('productDescription').value,
        active: document.getElementById('productActive').checked
    };
    
    const url = id ? `${API_BASE}/${id}/` : `${API_BASE}/`;
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(() => {
        bootstrap.Modal.getInstance(document.getElementById('productModal')).hide();
        loadProducts();
    })
    .catch(err => alert('Error: ' + err.message));
}

function deleteProduct(id) {
    if (!confirm('Are you sure you want to delete this product?')) return;
    
    fetch(`${API_BASE}/${id}/`, { method: 'DELETE' })
        .then(() => loadProducts())
        .catch(err => alert('Error: ' + err.message));
}

function bulkDelete() {
    if (!confirm('Are you sure you want to delete ALL products? This cannot be undone!')) return;
    
    fetch(`${API_BASE}/bulk-delete/`, { method: 'DELETE' })
        .then(res => res.json())
        .then(data => {
            alert(data.message);
            loadProducts();
        })
        .catch(err => alert('Error: ' + err.message));
}

// Load products on page load
loadProducts();
</script>
{% endblock %}

