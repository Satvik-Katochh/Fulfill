{% extends "base.html" %}

{% block title %}Webhooks - Product Importer{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h2><i class="bi bi-link-45deg"></i> Webhooks</h2>
            <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#webhookModal" onclick="openCreateModal()">
                <i class="bi bi-plus-circle"></i> Add Webhook
            </button>
        </div>
    </div>
</div>

<div class="card">
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>URL</th>
                        <th>Event Type</th>
                        <th>Status</th>
                        <th>Created</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="webhooksTable">
                    <tr>
                        <td colspan="6" class="text-center">Loading...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Webhook Modal -->
<div class="modal fade" id="webhookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">Add Webhook</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="webhookForm">
                    <input type="hidden" id="webhookId">
                    <div class="mb-3">
                        <label for="webhookUrl" class="form-label">URL *</label>
                        <input type="url" class="form-control" id="webhookUrl" placeholder="https://example.com/webhook" required>
                    </div>
                    <div class="mb-3">
                        <label for="webhookEventType" class="form-label">Event Type *</label>
                        <select class="form-select" id="webhookEventType" required>
                            <option value="">Select event type</option>
                            <option value="product.created">Product Created</option>
                            <option value="product.updated">Product Updated</option>
                            <option value="product.deleted">Product Deleted</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="webhookEnabled" checked>
                            <label class="form-check-label" for="webhookEnabled">Enabled</label>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveWebhook()">Save</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
const API_BASE = '/api/webhooks';

function loadWebhooks() {
    fetch(API_BASE + '/')
        .then(res => res.json())
        .then(webhooks => {
            renderWebhooks(webhooks.results || webhooks);
        })
        .catch(err => {
            console.error('Error loading webhooks:', err);
            document.getElementById('webhooksTable').innerHTML = 
                '<tr><td colspan="6" class="text-center text-danger">Error loading webhooks</td></tr>';
        });
}

function renderWebhooks(webhooks) {
    const tbody = document.getElementById('webhooksTable');
    if (webhooks.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">No webhooks configured</td></tr>';
        return;
    }
    
    tbody.innerHTML = webhooks.map(w => `
        <tr>
            <td>${w.id}</td>
            <td><code>${w.url}</code></td>
            <td><span class="badge bg-info">${w.event_type}</span></td>
            <td>${w.enabled ? '<span class="badge bg-success">Enabled</span>' : '<span class="badge bg-secondary">Disabled</span>'}</td>
            <td>${new Date(w.created_at).toLocaleDateString()}</td>
            <td>
                <button class="btn btn-sm btn-success" onclick="testWebhook(${w.id})" title="Test">
                    <i class="bi bi-play-circle"></i>
                </button>
                <button class="btn btn-sm btn-primary" onclick="editWebhook(${w.id})" title="Edit">
                    <i class="bi bi-pencil"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteWebhook(${w.id})" title="Delete">
                    <i class="bi bi-trash"></i>
                </button>
            </td>
        </tr>
    `).join('');
}

function openCreateModal() {
    document.getElementById('modalTitle').textContent = 'Add Webhook';
    document.getElementById('webhookForm').reset();
    document.getElementById('webhookId').value = '';
    document.getElementById('webhookEnabled').checked = true;
}

function editWebhook(id) {
    fetch(`${API_BASE}/${id}/`)
        .then(res => res.json())
        .then(webhook => {
            document.getElementById('modalTitle').textContent = 'Edit Webhook';
            document.getElementById('webhookId').value = webhook.id;
            document.getElementById('webhookUrl').value = webhook.url;
            document.getElementById('webhookEventType').value = webhook.event_type;
            document.getElementById('webhookEnabled').checked = webhook.enabled;
            new bootstrap.Modal(document.getElementById('webhookModal')).show();
        });
}

function saveWebhook() {
    const id = document.getElementById('webhookId').value;
    const data = {
        url: document.getElementById('webhookUrl').value,
        event_type: document.getElementById('webhookEventType').value,
        enabled: document.getElementById('webhookEnabled').checked
    };
    
    const url = id ? `${API_BASE}/${id}/` : `${API_BASE}/`;
    const method = id ? 'PUT' : 'POST';
    
    fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
    })
    .then(res => res.json())
    .then(() => {
        bootstrap.Modal.getInstance(document.getElementById('webhookModal')).hide();
        loadWebhooks();
    })
    .catch(err => alert('Error: ' + err.message));
}

function deleteWebhook(id) {
    if (!confirm('Are you sure you want to delete this webhook?')) return;
    
    fetch(`${API_BASE}/${id}/`, { method: 'DELETE' })
        .then(() => loadWebhooks())
        .catch(err => alert('Error: ' + err.message));
}

function testWebhook(id) {
    fetch(`${API_BASE}/${id}/test/`, { method: 'POST' })
        .then(res => res.json())
        .then(data => {
            const status = data.status === 'success' ? 'success' : 'danger';
            const message = `Status: ${data.status_code || 'N/A'}\nResponse Time: ${data.response_time || 'N/A'}s\nStatus: ${data.status}`;
            alert(message);
        })
        .catch(err => alert('Error testing webhook: ' + err.message));
}

// Load webhooks on page load
loadWebhooks();
</script>
{% endblock %}

